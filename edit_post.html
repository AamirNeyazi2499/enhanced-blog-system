<!-- templates/edit_post.html -->
{% extends "base.html" %}

{% block title %}Edit: {{ post.title }} - Blog System{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Back Button -->
            <div class="mb-3">
                <a href="{{ url_for('view_post', post_id=post.id) }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left"></i> Back to Post
                </a>
            </div>

            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-edit"></i> Edit Blog Post
                    </h4>
                    <small class="text-muted">
                        Originally created on {{ post.created_at.strftime('%B %d, %Y') }}
                        {% if post.updated_at != post.created_at %}
                        • Last updated: {{ post.updated_at.strftime('%B %d, %Y') }}
                        {% endif %}
                    </small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-check-circle text-success"></i> Best Practices</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-arrow-right text-primary"></i> Review your changes carefully</li>
                                <li><i class="fas fa-arrow-right text-primary"></i> Use the preview feature</li>
                                <li><i class="fas fa-arrow-right text-primary"></i> Check for typos and grammar</li>
                                <li><i class="fas fa-arrow-right text-primary"></i> Ensure content flows well</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle text-info"></i> Revision Notes</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-arrow-right text-primary"></i> Changes update the timestamp</li>
                                <li><i class="fas fa-arrow-right text-primary"></i> Use drafts for work in progress</li>
                                <li><i class="fas fa-arrow-right text-primary"></i> Published posts are visible to all
                                </li>
                                <li><i class="fas fa-arrow-right text-primary"></i> Use Reset to revert changes</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Unsaved Changes Warning Modal -->
<div class="modal fade" id="unsavedChangesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    Unsaved Changes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You have unsaved changes. Are you sure you want to leave without saving?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Stay on Page
                </button>
                <button type="button" class="btn btn-warning" onclick="confirmLeave()">
                    Leave Without Saving
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Store original values for comparison
    const originalTitle = `{{ post.title }}`;
    const originalContent = `{{ post.content }}`;
    const originalPublished = {{ 'true' if post.is_published else 'false' }};
    let hasUnsavedChanges = false;
    let pendingNavigation = null;

    document.addEventListener('DOMContentLoaded', function () {
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        const publishedInput = document.getElementById('is_published');
        const titleCount = document.getElementById('titleCount');
        const contentCount = document.getElementById('contentCount');
        const wordCount = document.getElementById('wordCount');

        // Initialize word count
        updateWordCount();
        updatePreview();

        // Character counters
        titleInput.addEventListener('input', function () {
            titleCount.textContent = this.value.length;
            if (this.value.length > 180) {
                titleCount.style.color = '#dc3545';
            } else {
                titleCount.style.color = '#6c757d';
            }
            checkForChanges();
        });

        contentInput.addEventListener('input', function () {
            updateWordCount();
            checkForChanges();

            // Debounced preview update
            clearTimeout(this.previewTimeout);
            this.previewTimeout = setTimeout(updatePreview, 500);
        });

        publishedInput.addEventListener('change', function () {
            checkForChanges();
            updatePreview();
        });

        // Form validation
        document.getElementById('editPostForm').addEventListener('submit', function (e) {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (!title || !content) {
                e.preventDefault();
                alert('Please fill in all required fields.');
                return false;
            }

            if (title.length < 3) {
                e.preventDefault();
                alert('Title must be at least 3 characters long.');
                titleInput.focus();
                return false;
            }

            if (content.length < 10) {
                e.preventDefault();
                alert('Content must be at least 10 characters long.');
                contentInput.focus();
                return false;
            }

            // Clear the unsaved changes flag
            hasUnsavedChanges = false;
        });

        // Prevent accidental navigation
        window.addEventListener('beforeunload', function (e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        // Handle navigation links
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', function (e) {
                if (hasUnsavedChanges && !link.getAttribute('href').startsWith('#')) {
                    e.preventDefault();
                    pendingNavigation = link.getAttribute('href');
                    const modal = new bootstrap.Modal(document.getElementById('unsavedChangesModal'));
                    modal.show();
                }
            });
        });
    });

    function updateWordCount() {
        const content = document.getElementById('content').value;
        const contentCount = document.getElementById('contentCount');
        const wordCount = document.getElementById('wordCount');

        contentCount.textContent = content.length;

        const words = content.trim().split(/\s+/).filter(word => word.length > 0);
        wordCount.textContent = content.trim() === '' ? 0 : words.length;
    }

    function checkForChanges() {
        const currentTitle = document.getElementById('title').value;
        const currentContent = document.getElementById('content').value;
        const currentPublished = document.getElementById('is_published').checked;

        hasUnsavedChanges = (currentTitle !== originalTitle) ||
            (currentContent !== originalContent) ||
            (currentPublished !== originalPublished);

        // Update page title to show unsaved changes
        const titleElement = document.querySelector('title');
        if (hasUnsavedChanges) {
            if (!titleElement.textContent.includes('*')) {
                titleElement.textContent = '* ' + titleElement.textContent;
            }
        } else {
            titleElement.textContent = titleElement.textContent.replace('* ', '');
        }
    }

    function updatePreview() {
        const title = document.getElementById('title').value;
        const content = document.getElementById('content').value;
        const isPublished = document.getElementById('is_published').checked;
        const previewContent = document.getElementById('previewContent');

        const formattedContent = content.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');

        previewContent.innerHTML = `
        <h5 class="card-title">${title || 'Untitled Post'}</h5>
        <div class="post-meta mb-3">
            <small class="text-muted">
                <i class="fas fa-user"></i> {{ post.author.get_full_name() }} (@{{ post.author.username }}) • 
                <i class="fas fa-calendar"></i> {{ post.created_at.strftime('%B %d, %Y') }} •
                <i class="fas fa-edit"></i> Updated: ${new Date().toLocaleDateString()}
                ${!isPublished ? ' • <span class="badge bg-warning text-dark">Draft</span>' : ''}
            </small>
        </div>
        <div class="post-content">
            <p>${formattedContent || 'No content yet...'}</p>
        </div>
    `;
    }

    function resetForm() {
        if (confirm('Are you sure you want to reset all changes? This cannot be undone.')) {
            document.getElementById('title').value = originalTitle;
            document.getElementById('content').value = originalContent;
            document.getElementById('is_published').checked = originalPublished;

            // Trigger input events to update counters
            document.getElementById('title').dispatchEvent(new Event('input'));
            document.getElementById('content').dispatchEvent(new Event('input'));

            hasUnsavedChanges = false;
            updatePreview();
        }
    }

    function confirmLeave() {
        hasUnsavedChanges = false;
        const modal = bootstrap.Modal.getInstance(document.getElementById('unsavedChangesModal'));
        modal.hide();

        if (pendingNavigation) {
            window.location.href = pendingNavigation;
            pendingNavigation = null;
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        // Ctrl/Cmd + S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            document.getElementById('editPostForm').submit();
        }

        // Ctrl/Cmd + Z to reset (undo all changes)
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            resetForm();
        }

        // Ctrl/Cmd + P to preview
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            updatePreview();
        }

        // Escape to cancel (with confirmation if there are changes)
        if (e.key === 'Escape') {
            e.preventDefault();
            if (hasUnsavedChanges) {
                const modal = new bootstrap.Modal(document.getElementById('unsavedChangesModal'));
                pendingNavigation = '{{ url_for("view_post", post_id=post.id) }}';
                modal.show();
            } else {
                window.location.href = '{{ url_for("view_post", post_id=post.id) }}';
            }
        }
    });

    // Real-time preview updates
    document.getElementById('title').addEventListener('input', updatePreview);
    document.getElementById('content').addEventListener('input', function () {
        clearTimeout(this.previewTimeout);
        this.previewTimeout = setTimeout(updatePreview, 500);
    });
    document.getElementById('is_published').addEventListener('change', updatePreview);
</script>
{% endblock %}<form method="POST" id="editPostForm">
    <div class="mb-4">
        <label for="title" class="form-label">
            <i class="fas fa-heading"></i> Post Title *
        </label>
        <input type="text" class="form-control form-control-lg" id="title" name="title" value="{{ post.title }}"
            placeholder="Enter an engaging title for your post" required maxlength="200">
        <div class="form-text">
            <span id="titleCount">{{ post.title|length }}</span>/200 characters
        </div>
    </div>

    <div class="mb-4">
        <label for="content" class="form-label">
            <i class="fas fa-align-left"></i> Content *
        </label>
        <textarea class="form-control" id="content" name="content" rows="15"
            placeholder="Write your blog post content here..." required>{{ post.content }}</textarea>
        <div class="form-text">
            <span id="contentCount">{{ post.content|length }}</span> characters • <span id="wordCount">0</span> words
        </div>
    </div>

    <div class="mb-4 form-check">
        <input type="checkbox" class="form-check-input" id="is_published" name="is_published" {{ 'checked' if
            post.is_published else '' }}>
        <label class="form-check-label" for="is_published">
            <i class="fas fa-globe"></i> Published
        </label>
        <div class="form-text">
            Uncheck to save as draft. Check to make visible to all users.
        </div>
    </div>

    <!-- Changes Preview -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">
                <i class="fas fa-eye"></i> Preview Changes
            </label>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="updatePreview()">
                <i class="fas fa-refresh"></i> Update Preview
            </button>
        </div>
        <div class="card">
            <div class="card-body" id="previewContent">
                <!-- Initial preview will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
        <div>
            <a href="{{ url_for('view_post', post_id=post.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
            <button type="button" class="btn btn-info" onclick="updatePreview()">
                <i class="fas fa-eye"></i> Preview
            </button>
        </div>
        <div>
            <button type="button" class="btn btn-warning" onclick="resetForm()">
                <i class="fas fa-undo"></i> Reset Changes
            </button>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Update Post
            </button>
        </div>
    </div>
</form>
</div>
</div>

<!-- Editing Tips Card -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-lightbulb"></i> Editing Tips
        </h5>
    </div>
    <div class="card-body">