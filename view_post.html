<!-- templates/view_post.html -->
{% extends "base.html" %}

{% block title %}{{ post.title }} - Blog System{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Back Button -->
            <div class="mb-3">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left"></i> Back to Posts
                </a>
            </div>

            <!-- Main Post Card -->
            <article class="card">
                <div class="card-header bg-white border-0 pt-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h1 class="card-title h2 mb-3">{{ post.title }}</h1>
                            <div class="post-meta mb-3">
                                <span class="badge bg-primary me-2">
                                    <i class="fas fa-user"></i> {{ post.author.get_full_name() }}
                                </span>
                                <span class="text-muted">
                                    <i class="fas fa-at"></i> @{{ post.author.username }} •
                                    <i class="fas fa-calendar"></i> 
                                    Published: {{ post.created_at.strftime('%B %d, %Y') }}
                                </span>
                                {% if post.updated_at != post.created_at %}
                                <span class="text-muted ms-2">
                                    <i class="fas fa-edit"></i> 
                                    Updated: {{ post.updated_at.strftime('%B %d, %Y') }}
                                </span>
                                {% endif %}
                                {% if not post.is_published %}
                                <span class="badge bg-warning text-dark ms-2">Draft</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if current_user.is_authenticated and current_user.id == post.user_id %}
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" 
                                    type="button" 
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-cog"></i> Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('edit_post', post_id=post.id) }}">
                                        <i class="fas fa-edit"></i> Edit Post
                                    </a>
                                </li>
                                <li>
                                    <button class="dropdown-item" onclick="sharePost()">
                                        <i class="fas fa-share-alt"></i> Share Post
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" onclick="printPost()">
                                        <i class="fas fa-print"></i> Print Post
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <button class="dropdown-item text-danger" 
                                            onclick="deletePost({{ post.id }}, '{{ post.title }}')">
                                        <i class="fas fa-trash"></i> Delete Post
                                    </button>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card-body pt-0">
                    <!-- Reading Time Estimate -->
                    <div class="alert alert-info d-flex align-items-center mb-4">
                        <i class="fas fa-clock me-2"></i>
                        <span id="readingTime">Calculating reading time...</span>
                    </div>

                    <!-- Post Content -->
                    <div class="post-content" style="line-height: 1.8; font-size: 1.1rem;">
                        {% set paragraphs = post.content.split('\n\n') %}
                        {% for paragraph in paragraphs %}
                            {% if paragraph.strip() %}
                                <p>{{ paragraph.replace('\n', '<br>')|safe }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="card-footer bg-transparent">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                {% if current_user.is_authenticated and current_user.id == post.user_id %}
                                <a href="{{ url_for('edit_post', post_id=post.id) }}" 
                                   class="btn btn-primary">
                                    <i class="fas fa-edit"></i> Edit Post
                                </a>
                                {% endif %}
                                <button class="btn btn-outline-secondary" onclick="sharePost()">
                                    <i class="fas fa-share-alt"></i> Share
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end mt-2 mt-md-0">
                            <small class="text-muted">
                                Post ID: #{{ post.id }} • 
                                <span id="wordCountDisplay">0</span> words
                            </small>
                        </div>
                    </div>
                </div>
            </article>

            <!-- Author Info Card -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px; color: white; font-size: 1.5rem;">
                                {{ post.author.first_name[0].upper() }}{{ post.author.last_name[0].upper() }}
                            </div>
                        </div>
                        <div class="col">
                            <h6 class="mb-0">{{ post.author.get_full_name() }}</h6>
                            <p class="text-muted mb-0">@{{ post.author.username }}</p>
                            {% if post.author.bio %}
                            <p class="mb-0 mt-2">{{ post.author.bio }}</p>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            <small class="text-muted">
                                {{ post.author.posts|selectattr('is_published')|list|length }} posts
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Post Statistics -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-line"></i> Post Statistics
                    </h5>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="p-2">
                                <i class="fas fa-align-left fa-2x text-primary mb-2"></i>
                                <h5 id="charCount">0</h5>
                                <small class="text-muted">Characters</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-2">
                                <i class="fas fa-paragraph fa-2x text-success mb-2"></i>
                                <h5 id="paragraphCount">0</h5>
                                <small class="text-muted">Paragraphs</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-2">
                                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                                <h5 id="readingTimeMinutes">0</h5>
                                <small class="text-muted">Min Read</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-2">
                                <i class="fas fa-calendar-plus fa-2x text-warning mb-2"></i>
                                <h5 id="daysAgo">0</h5>
                                <small class="text-muted">Days Ago</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation to Other Posts -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-compass"></i> More Posts
                    </h5>
                    <div class="text-center">
                        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                            <i class="fas fa-list"></i> View All Posts
                        </a>
                        {% if current_user.is_authenticated %}
                        <a href="{{ url_for('create_post') }}" class="btn btn-outline-success ms-2">
                            <i class="fas fa-plus"></i> Create New Post
                        </a>
                        <a href="{{ url_for('profile') }}" class="btn btn-outline-info ms-2">
                            <i class="fas fa-user"></i> My Profile
                        </a>
                        {% else %}
                        <a href="{{ url_for('register') }}" class="btn btn-outline-success ms-2">
                            <i class="fas fa-user-plus"></i> Join Community
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% if current_user.is_authenticated and current_user.id == post.user_id %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning"></i> 
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this post?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Post
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-share-alt"></i> Share Post
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Post URL:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="postUrl" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyUrl()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="shareOnSocial('twitter')">
                        <i class="fab fa-twitter"></i> Share on Twitter
                    </button>
                    <button class="btn btn-primary" onclick="shareOnSocial('facebook')">
                        <i class="fab fa-facebook"></i> Share on Facebook
                    </button>
                    <button class="btn btn-success" onclick="shareOnSocial('whatsapp')">
                        <i class="fab fa-whatsapp"></i> Share on WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const postContent = document.querySelector('.post-content');
    const content = postContent.textContent || postContent.innerText;
    
    // Calculate statistics
    const charCount = content.length;
    const words = content.trim().split(/\s+/).filter(word => word.length > 0);
    const wordCount = content.trim() === '' ? 0 : words.length;
    const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim().length > 0);
    const paragraphCount = Math.max(1, paragraphs.length);
    
    // Reading speed: 220 words per minute
    const readingTimeMinutes = Math.max(1, Math.ceil(wordCount / 220));
    
    // Calculate days ago
    const createdAt = new Date('{{ post.created_at.isoformat() }}');
    const now = new Date();
    const daysAgo = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
    
    // Update statistics
    document.getElementById('charCount').textContent = charCount.toLocaleString();
    document.getElementById('wordCountDisplay').textContent = wordCount.toLocaleString();
    document.getElementById('paragraphCount').textContent = paragraphCount;
    document.getElementById('readingTimeMinutes').textContent = readingTimeMinutes;
    document.getElementById('daysAgo').textContent = daysAgo;
    document.getElementById('readingTime').textContent = `⏱️ ${readingTimeMinutes} minute${readingTimeMinutes !== 1 ? 's' : ''} read (${wordCount} words)`;
    
    // Set post URL for sharing
    if (document.getElementById('postUrl')) {
        document.getElementById('postUrl').value = window.location.href;
    }
});

{% if current_user.is_authenticated and current_user.id == post.user_id %}
function deletePost(postId, postTitle) {
    document.getElementById('deleteForm').action = '{{ url_for("delete_post", post_id=0) }}'.replace('0', postId);
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}
{% endif %}

function sharePost() {
    const modal = new bootstrap.Modal(document.getElementById('shareModal'));
    modal.show();
}

function copyUrl() {
    const urlInput = document.getElementById('postUrl');
    urlInput.select();
    document.execCommand('copy');
    
    // Show feedback
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
    btn.classList.remove('btn-outline-secondary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');
    }, 2000);
}

function shareOnSocial(platform) {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.querySelector('.card-title').textContent);
    
    let shareUrl = '';
    
    switch(platform) {
        case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
            break;
        case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            break;
        case 'whatsapp':
            shareUrl = `https://wa.me/?text=${title}%20${url}`;
            break;
    }
    
    if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
    }
}

function printPost() {
    const printWindow = window.open('', '_blank');
    const postTitle = document.querySelector('.card-title').textContent;
    const postAuthor = '{{ post.author.get_full_name() }}';
    const postDate = '{{ post.created_at.strftime("%B %d, %Y") }}';
    const postContent = document.querySelector('.post-content').innerHTML;
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${postTitle}</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                .meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
                .content { line-height: 1.6; font-size: 16px; }
                @media print { body { padding: 0; } }
            </style>
        </head>
        <body>
            <h1>${postTitle}</h1>
            <div class="meta">By ${postAuthor} • ${postDate}</div>
            <div class="content">${postContent}</div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 250);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    {% if current_user.is_authenticated and current_user.id == post.user_id %}
    // E key to edit
    if (e.key === 'e' && !e.ctrlKey && !e.metaKey && !e.target.matches('input, textarea')) {
        window.location.href = '{{ url_for("edit_post", post_id=post.id) }}';
    }
    {% endif %}
    
    // Backspace to go back
    if (e.key === 'Backspace' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        window.location.href = '{{ url_for("index") }}';
    }
});

// Add reading progress indicator
window.addEventListener('scroll', function() {
    const article = document.querySelector('article');
    if (article) {
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const scrollTop = window.pageYOffset;
        const windowHeight = window.innerHeight;
        
        const progress = Math.min(100, Math.max(0, 
            ((scrollTop - articleTop + windowHeight) / articleHeight) * 100
        ));
        
        let progressBar = document.getElementById('readingProgress');
        if (!progressBar) {
            progressBar = document.createElement('div');
            progressBar.id = 'readingProgress';
            progressBar.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: ${progress}%;
                height: 3px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                z-index: 1000;
                transition: width 0.1s ease;
            `;
            document.body.appendChild(progressBar);
        } else {
            progressBar.style.width = progress + '%';
        }
    }
});
</script>
{% endblock %}